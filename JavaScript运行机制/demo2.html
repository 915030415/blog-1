<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JavaScript运行机制</title>
    <style type="text/css">
        body {
            height: 800px;
        }
    </style>
</head>
<body>
    <button id="red">红色</button>
    <button id="green">绿色</button>
    <button id="blue">蓝色</button>
    <script type="text/javascript">
        (function(){
            window.$ = function () {}
            function ajax(method, url, success) {
                var r = new XMLHttpRequest();
                r.onreadystatechange = function() {
                    if(r.readyState == 4 && (r.status == 200 || r.status == 0))
                        success(JSON.parse(r.responseText));
                };
                r.open(method,url,true);
                r.setRequestHeader('X-Requested-With','XMLHttpRequest');
                r.send(null);
            }

            $.get = function(url, success){ ajax('GET', url, success); };
            $.post = function(url, success){ ajax('POST', url, success); };
            $.getJSON = function(url, success){
                $.get(url, function(json){ success(JSON.parse(json)) });
            };
        })();
    </script>
    <script type="text/javascript">
        setInterval(function () {
            console.log('setInterval...');
        }, 0);
        setTimeout(() => {
            console.log('setTimeout1...')
        }, 1000 * 60);   // 60秒后执行
        window.onload = function() {	// 页面包含图片等文件在内的所有元素都加载完成。
            console.log('onload before...');
            for (let i = 0; i < 9000000000; i ++) {}
            console.log('onload after...');
        }
        setTimeout(() => {
            console.log('setTimeout2...')
        }, 0);
        document.addEventListener('DOMContentLoaded', function () {		// dom结构加载完毕后执行
            console.log('DOMContentLoaded before...');
            for (let i = 0; i < 9000000000; i ++) {}
            console.log('DOMContentLoaded after...');
        });
        setTimeout(() => {
            console.log('setTimeout3 before...')
            for (let i = 0; i < 9000000000; i ++) {}
            console.log('setTimeout3 after...')
        }, 0);
        $.get('/user', function (res) {
            console.log('/user before => ', res);
            // for (let i = 0; i < 9000000000; i ++) {}	// 阻塞下一个ajax请求的回调函数执行，下一个ajax请求函数会一只处于pending状态，直到这个回调函数的逻辑执行完毕。其实服务端早就返回
            console.log('/user after => ', res);
        });
        setTimeout(() => {
            console.log('setTimeout4...')
        }, 0);
        $.get('/list', function (res) {
            console.log('/list => ', res);
        });
        document.querySelector('#red').addEventListener('click', function (e) {	// 点击事件监听
            console.log('red');
            document.querySelector('body').style.backgroundColor = 'red';
        });
        document.querySelector('#green').addEventListener('click', function (e) {
            console.log('green')
            document.querySelector('body').style.backgroundColor = 'green';	// 异步的，颜色会等主逻辑代码全部执行完毕后才变化
            console.log(document.querySelector('body').style.backgroundColor);
            for (let i = 0; i < 5000000000; i ++) {}
        });
        document.querySelector('#blue').addEventListener('click', function (e) {
            console.log('blue')
            document.querySelector('body').style.backgroundColor = 'blue';
        });
        Promise.resolve({name: 'wen'}).then(res => {
            console.log('1.promise...', res);
        });
        const rafcb = function() {
            console.log('requestAnimationFrame...');
            requestAnimationFrame(rafcb);
        }
        requestAnimationFrame(rafcb);
        Promise.resolve({name: 'wen'}).then(res => {
            console.log('2.promise...', res);
            for (let i = 0; i < 5000000000; i ++) {}
        });
        for (let i = 0; i < 3000000000; i ++) {}
        console.log('main logic .....')
    </script>
</body>
</html>
